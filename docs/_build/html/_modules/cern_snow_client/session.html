
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>cern_snow_client.session &#8212; cern-snow-client 0.3 documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">cern-snow-client 0.3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cern_snow_client.session</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1"># This file is part of the cern-snow-client library.</span>
<span class="c1"># Copyright (c) 2017 CERN</span>
<span class="c1"># Authors:</span>
<span class="c1">#  - James Clerc &lt;james.clerc@cern.ch&gt; &lt;james.clerc@epitech.eu&gt;</span>
<span class="c1">#  - David Martin Clavo &lt;david.martin.clavo@cern.ch&gt;</span>
<span class="c1">#</span>
<span class="c1"># The cern-snow-client library is free software; you can redistribute it</span>
<span class="c1"># and/or modify it under the terms of the GNU Lesser General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># The cern-snow-client library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;</span>
<span class="c1"># without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public License</span>
<span class="c1"># along with the cern-snow-client library.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="c1"># In applying this license, CERN does not waive the privileges and immunities granted to it by virtue of its status</span>
<span class="c1"># as an Intergovernmental Organization or submit itself to any jurisdiction.</span>

<span class="kn">import</span> <span class="nn">cookielib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">logging.handlers</span> <span class="k">import</span> <span class="n">RotatingFileHandler</span>

<span class="k">try</span><span class="p">:</span>  <span class="c1"># Python 2.7+</span>
    <span class="kn">from</span> <span class="nn">logging</span> <span class="k">import</span> <span class="n">NullHandler</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">NullHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
            <span class="k">pass</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">common</span> <span class="k">import</span> <span class="n">SnowClientException</span>


<div class="viewcode-block" id="SnowRestSession"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession">[docs]</a><span class="k">class</span> <span class="nc">SnowRestSession</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class behaves very similarly to a requests.Session object.</span>
<span class="sd">    It can be configured by loading a .yaml config file,</span>
<span class="sd">    or by setting attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sso_method</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_user</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_password</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oauth_client_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oauth_client_secret</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_cookie_file_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_cookie</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oauth_token_file_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fresh_cookie</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fresh_token</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_cookie</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_token</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log_enabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span> <span class="o">=</span> <span class="s1">&#39;snow-client.session_&#39;</span> <span class="o">+</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="o">-</span><span class="mi">24</span><span class="p">]</span>  <span class="c1"># used to get a Logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_handler</span> <span class="o">=</span> <span class="n">NullHandler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_handler</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log_file_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_level</span> <span class="o">=</span> <span class="s1">&#39;INFO&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> [</span><span class="si">%(name)s</span><span class="s2">] [</span><span class="si">%(levelname)s</span><span class="s2">] </span><span class="si">%(message)s</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_file_size_bytes</span> <span class="o">=</span> <span class="mi">1000000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_file_rotations</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_file_encoding</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span>

<div class="viewcode-block" id="SnowRestSession.load_config_file"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.load_config_file">[docs]</a>    <span class="k">def</span> <span class="nf">load_config_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a .yaml configuration file</span>

<span class="sd">        Args:</span>
<span class="sd">            config_file_path (str): the path to the configuration file</span>

<span class="sd">        Raises:</span>
<span class="sd">            SnowRestSessionException: if no file is found at the specified path, or some inconsistency is found</span>
<span class="sd">                in the file.</span>
<span class="sd">            Exception: if some other error happens when opening or parsing the file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config_file_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span>
                <span class="s2">&quot;SnowRestSession.load_config_file: the parameter config_file_path must have a value&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">config_file</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;SnowRestSession.load_config_file: Issue when opening the config file at </span><span class="si">%s</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">config_file_path</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="k">if</span> <span class="s1">&#39;instance&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_instance</span><span class="p">(</span><span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;instance&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;auth&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_type</span> <span class="o">==</span> <span class="s1">&#39;sso_oauth&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;sso_method&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sso_method</span> <span class="o">=</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;sso_method&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;oauth_client_id&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">oauth_client_id</span> <span class="o">=</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;oauth_client_id&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;oauth_client_secret&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">oauth_client_secret</span> <span class="o">=</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;oauth_client_secret&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;session&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;cookie_file&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session_cookie_file_path</span> <span class="o">=</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">][</span><span class="s1">&#39;cookie_file&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;oauth_tokens_file&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">oauth_token_file_path</span> <span class="o">=</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">][</span><span class="s1">&#39;oauth_tokens_file&#39;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_type</span> <span class="o">==</span> <span class="s1">&#39;basic&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;user&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_user</span> <span class="o">=</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;password&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_password</span> <span class="o">=</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;session&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;cookie_file&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session_cookie_file_path</span> <span class="o">=</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">][</span><span class="s1">&#39;cookie_file&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span>
                <span class="s2">&quot;SnowRestSession.load_config_file: the property </span><span class="se">\&quot;</span><span class="s2">auth_type</span><span class="se">\&quot;</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;must have a value of </span><span class="se">\&quot;</span><span class="s2">sso_auth</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">basic</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;log&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;log_enabled&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">][</span><span class="s1">&#39;log_enabled&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_enabled</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s1">&#39;log_level&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_log_level</span><span class="p">(</span><span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">][</span><span class="s1">&#39;log_level&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;log_file_path&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_file_path</span> <span class="o">=</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">][</span><span class="s1">&#39;log_file_path&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;log_format&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_format</span> <span class="o">=</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">][</span><span class="s1">&#39;log_format&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;log_file_size_bytes&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_file_size_bytes</span> <span class="o">=</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">][</span><span class="s1">&#39;log_file_size_bytes&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;log_file_rotations&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_file_rotations</span> <span class="o">=</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">][</span><span class="s1">&#39;log_file_rotations&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;log_file_encoding&#39;</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_file_encoding</span> <span class="o">=</span> <span class="n">config_file</span><span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">][</span><span class="s1">&#39;log_file_encoding&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure_handler</span><span class="p">()</span></div>

<div class="viewcode-block" id="SnowRestSession.set_instance"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.set_instance">[docs]</a>    <span class="k">def</span> <span class="nf">set_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            instance (str): the ServiceNow instance to use. It is optional to prefix with &quot;https://&quot;.</span>
<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; s = SnowRestSession()</span>
<span class="sd">            &gt;&gt;&gt; s.set_instance(&quot;cern.service-now.com&quot;)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; s2 = SnowRestSession()</span>
<span class="sd">            &gt;&gt;&gt; s2.set_instance(&quot;https://cerntest.service-now.com&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;https://&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="s1">&#39;https://&#39;</span> <span class="o">+</span> <span class="n">instance</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span></div>

<div class="viewcode-block" id="SnowRestSession.set_auth_type"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.set_auth_type">[docs]</a>    <span class="k">def</span> <span class="nf">set_auth_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auth_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            auth_type (str): the authentication type to use. Either &#39;sso_auth&#39; or &#39;basic&#39;</span>

<span class="sd">        Raises:</span>
<span class="sd">            SnowRestSessionException: if auth_type is not &#39;sso_auth&#39; or &#39;basic&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">auth_type</span> <span class="o">!=</span> <span class="s1">&#39;basic&#39;</span> <span class="ow">and</span> <span class="n">auth_type</span> <span class="o">!=</span> <span class="s1">&#39;sso_auth&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span>
                <span class="s2">&quot;SnowRestSession.set_auth_type: the parameter </span><span class="se">\&quot;</span><span class="s2">auth_type</span><span class="se">\&quot;</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;must have a value of </span><span class="se">\&quot;</span><span class="s2">sso_auth</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">basic</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">auth_type</span></div>

<div class="viewcode-block" id="SnowRestSession.set_sso_method"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.set_sso_method">[docs]</a>    <span class="k">def</span> <span class="nf">set_sso_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sso_method</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            sso_method (str): the Single Sign On method to use. Either &#39;kerberos&#39; or &#39;certificate&#39;.</span>
<span class="sd">            Needs set_auth_type(&#39;sso_auth&#39;) to have an effect.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SnowRestSessionException: if sso_method is not &#39;kerberos&#39; or &#39;certificate&#39;</span>

<span class="sd">        Note: certificate support needs to be implemented</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sso_method</span> <span class="o">!=</span> <span class="s1">&#39;kerberos&#39;</span> <span class="ow">and</span> <span class="n">sso_method</span> <span class="o">!=</span> <span class="s1">&#39;certificate&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span>
                <span class="s2">&quot;SnowRestSession.set_sso_method: the parameter </span><span class="se">\&quot;</span><span class="s2">sso_method</span><span class="se">\&quot;</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;must have a value of </span><span class="se">\&quot;</span><span class="s2">kerberos</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">certificate</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># TODO: implement certificate support. Update the comment above</span>
        <span class="k">if</span> <span class="n">sso_method</span> <span class="o">==</span> <span class="s1">&#39;certificate&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span><span class="s2">&quot;SnowRestSession.set_sso_method: certificate support is not yet implemented&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sso_method</span> <span class="o">=</span> <span class="n">sso_method</span></div>

<div class="viewcode-block" id="SnowRestSession.set_oauth_client_id"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.set_oauth_client_id">[docs]</a>    <span class="k">def</span> <span class="nf">set_oauth_client_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oauth_client_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            oauth_client_id (str): the OAuth client id provided to you by your instance&#39;s ServiceNow administrator.</span>
<span class="sd">            Needs set_auth_type(&#39;sso_auth&#39;) to have an effect.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oauth_client_id</span> <span class="o">=</span> <span class="n">oauth_client_id</span></div>

<div class="viewcode-block" id="SnowRestSession.set_oauth_client_secret"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.set_oauth_client_secret">[docs]</a>    <span class="k">def</span> <span class="nf">set_oauth_client_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oauth_client_secret</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            oauth_client_secret (str): the OAuth client secret provided to you by your instance&#39;s</span>
<span class="sd">            ServiceNow administrator.</span>
<span class="sd">            Needs set_auth_type(&#39;sso_auth&#39;) to have an effect.</span>
<span class="sd">            An OAuth client secret is sensitive information; please store it as securely as possible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oauth_client_secret</span> <span class="o">=</span> <span class="n">oauth_client_secret</span></div>

<div class="viewcode-block" id="SnowRestSession.set_basic_auth_user"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.set_basic_auth_user">[docs]</a>    <span class="k">def</span> <span class="nf">set_basic_auth_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basic_auth_user</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            basic_auth_user (str): the name of the local ServiceNow account that will be used for authentication.</span>
<span class="sd">            Needs set_auth_type(&#39;basic&#39;) to have an effect.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_user</span> <span class="o">=</span> <span class="n">basic_auth_user</span></div>

<div class="viewcode-block" id="SnowRestSession.set_basic_auth_password"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.set_basic_auth_password">[docs]</a>    <span class="k">def</span> <span class="nf">set_basic_auth_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basic_auth_password</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            basic_auth_password (str): the password of the local ServiceNow account that will be used for</span>
<span class="sd">            authentication.</span>
<span class="sd">            Needs set_auth_type(&#39;basic&#39;) to have an effect.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_password</span> <span class="o">=</span> <span class="n">basic_auth_password</span></div>

<div class="viewcode-block" id="SnowRestSession.set_session_cookie_file_path"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.set_session_cookie_file_path">[docs]</a>    <span class="k">def</span> <span class="nf">set_session_cookie_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_cookie_file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            session_cookie_file_path (str): the path to the file where the session cookies will be persisted.</span>
<span class="sd">            If not provided, the cookies will not be persisted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_cookie_file_path</span> <span class="o">=</span> <span class="n">session_cookie_file_path</span></div>

<div class="viewcode-block" id="SnowRestSession.set_oauth_token_file_path"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.set_oauth_token_file_path">[docs]</a>    <span class="k">def</span> <span class="nf">set_oauth_token_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oauth_token_file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            oauth_token_file_path (str): the path to the file where the OAuth refresh and access tokens</span>
<span class="sd">            will be persisted. If not provided, the OAuth tokens will not be persisted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oauth_token_file_path</span> <span class="o">=</span> <span class="n">oauth_token_file_path</span></div>

<div class="viewcode-block" id="SnowRestSession.set_log_enabled"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.set_log_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">set_log_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_enabled</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_enabled</span> <span class="o">=</span> <span class="n">log_enabled</span></div>

<div class="viewcode-block" id="SnowRestSession.set_log_level"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.set_log_level">[docs]</a>    <span class="k">def</span> <span class="nf">set_log_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_level</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_level</span> <span class="o">=</span> <span class="n">log_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_level</span><span class="p">)</span></div>

<div class="viewcode-block" id="SnowRestSession.set_log_file_path"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.set_log_file_path">[docs]</a>    <span class="k">def</span> <span class="nf">set_log_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_file_path</span> <span class="o">=</span> <span class="n">log_file_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configure_handler</span><span class="p">()</span></div>

<div class="viewcode-block" id="SnowRestSession.set_log_format"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.set_log_format">[docs]</a>    <span class="k">def</span> <span class="nf">set_log_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_format</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_format</span> <span class="o">=</span> <span class="n">log_format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configure_handler</span><span class="p">()</span></div>

<div class="viewcode-block" id="SnowRestSession.set_log_file_size_bytes"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.set_log_file_size_bytes">[docs]</a>    <span class="k">def</span> <span class="nf">set_log_file_size_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file_size_bytes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_file_size_bytes</span> <span class="o">=</span> <span class="n">log_file_size_bytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configure_handler</span><span class="p">()</span></div>

<div class="viewcode-block" id="SnowRestSession.set_log_file_rotations"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.set_log_file_rotations">[docs]</a>    <span class="k">def</span> <span class="nf">set_log_file_rotations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file_rotations</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_file_rotations</span> <span class="o">=</span> <span class="n">log_file_rotations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configure_handler</span><span class="p">()</span></div>

<div class="viewcode-block" id="SnowRestSession.set_log_file_encoding"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.set_log_file_encoding">[docs]</a>    <span class="k">def</span> <span class="nf">set_log_file_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file_encoding</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_file_encoding</span> <span class="o">=</span> <span class="n">log_file_encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configure_handler</span><span class="p">()</span></div>

<div class="viewcode-block" id="SnowRestSession.is_logging_enabled"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.is_logging_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">is_logging_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_enabled</span></div>

<div class="viewcode-block" id="SnowRestSession.get_logger_name"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.get_logger_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_logger_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger_name</span></div>

<div class="viewcode-block" id="SnowRestSession.get_logger"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.get_logger">[docs]</a>    <span class="k">def</span> <span class="nf">get_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span></div>

<div class="viewcode-block" id="SnowRestSession.get_log_handler"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.get_log_handler">[docs]</a>    <span class="k">def</span> <span class="nf">get_log_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_handler</span></div>

<div class="viewcode-block" id="SnowRestSession.get"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a raw GET operation and returns the result.</span>
<span class="sd">        Used to read or retrieve information.</span>
<span class="sd">        The authentication method, and session cookie / OAuth tokens persistance will depend on how the session</span>
<span class="sd">        has been configured.</span>

<span class="sd">        Args:</span>
<span class="sd">            url (str): a relative URL, such as ``/api/now/v2/table/incident/c1c535ba85f45540adf94de5b835cd43``.</span>
<span class="sd">                An absolute URL such as ``https://cerntest.service-now.com/api/now/v2/table/incident/c1c535ba85f45540adf94de5b835cd43`` can also</span>
<span class="sd">                be used, but the instance should match with the &quot;instance&quot; parameter in the configuration file,</span>
<span class="sd">                or the value set with the ``.set_instance()`` method.</span>
<span class="sd">            headers (:obj:`dict`, optional): any additional headers to be be passed. If not set, the &#39;Accept&#39; header will be set to</span>
<span class="sd">                &#39;application/json&#39;</span>
<span class="sd">            params (:obj:`dict`, optional): any additional URL parameters to be be passed</span>

<span class="sd">        Returns:</span>
<span class="sd">            requests.Response : If the status code is not 401, a ``requests.Response`` object is returned.</span>
<span class="sd">            The structure of the result inside the &#39;text&#39; attribute might vary depending on the REST endpoint</span>
<span class="sd">            called and the way that the query is configured. ServiceNow may also set various HTTP status codes</span>
<span class="sd">            or headers in the response.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SnowRestSessionException : if the operation could not be performed due to an authentication issue</span>

<span class="sd">        Examples:</span>
<span class="sd">            Getting an incident by sys_id with the ServiceNow REST Table API:</span>

<span class="sd">            &gt;&gt;&gt; s = SnowRestSession()</span>
<span class="sd">            &gt;&gt;&gt; s.load_config_file(&#39;config.yaml&#39;)</span>
<span class="sd">            &gt;&gt;&gt; response = s.get(&#39;/api/now/v2/table/incident/c1c535ba85f45540adf94de5b835cd43&#39;)</span>
<span class="sd">            &gt;&gt;&gt; if response.status_code == 200:</span>
<span class="sd">            &gt;&gt;&gt;     import json</span>
<span class="sd">            &gt;&gt;&gt;     result = json.loads(response.text)</span>
<span class="sd">            &gt;&gt;&gt;     if &#39;result&#39; in result:</span>
<span class="sd">            &gt;&gt;&gt;         incident = result[&#39;result&#39;]  # querying by sys_id returns a single object</span>
<span class="sd">            &gt;&gt;&gt;         print incident[&#39;short_description&#39;]  # will print &quot;Test&quot; (as a unicode object)</span>

<span class="sd">            Getting an incident by number with the ServiceNow REST Table API:</span>

<span class="sd">            &gt;&gt;&gt; s = SnowRestSession()</span>
<span class="sd">            &gt;&gt;&gt; s.load_config_file(&#39;config.yaml&#39;)</span>
<span class="sd">            &gt;&gt;&gt; response = s.get(&#39;/api/now/v2/table/incident?sysparm_query=number=INC0426232&#39;)</span>
<span class="sd">            &gt;&gt;&gt; if response.status_code == 200:</span>
<span class="sd">            &gt;&gt;&gt;     import json</span>
<span class="sd">            &gt;&gt;&gt;     result = json.loads(response.text)</span>
<span class="sd">            &gt;&gt;&gt;     if &#39;result&#39; in result:</span>
<span class="sd">            &gt;&gt;&gt;         incident_array = result[&#39;result&#39;]  # querying via an encoded query returns an array of objects</span>
<span class="sd">            &gt;&gt;&gt;         if len(incident_array) &gt; 0:</span>
<span class="sd">            &gt;&gt;&gt;             incident = incident_array[0]</span>
<span class="sd">            &gt;&gt;&gt;             print incident[&#39;short_description&#39;]  # will print &quot;Test&quot; (as a unicode object)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__operation</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="SnowRestSession.post"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a raw POST operation and returns the result.</span>
<span class="sd">        Used to insert records or other information.</span>
<span class="sd">        The authentication method, and session cookie / OAuth tokens persistance will depend on how the session</span>
<span class="sd">        has been configured.</span>

<span class="sd">        Args:</span>
<span class="sd">            url (str): a relative URL, such as ``/api/now/v2/table/incident``.</span>
<span class="sd">                An absolute URL such as ``https://cerntest.service-now.com/api/now/v2/table/incident`` can also</span>
<span class="sd">                be used, but the instance should match with the &quot;instance&quot; parameter in the configuration file,</span>
<span class="sd">                or the value set with the ``.set_instance()`` method.</span>
<span class="sd">            headers (:obj:`dict`, optional): any additional headers to be be passed. If not set, the &#39;Accept&#39; header</span>
<span class="sd">                will be set to &#39;application/json&#39;, and &#39;Content&#39; will be set to &#39;application/json&#39;</span>
<span class="sd">            params (:obj:`dict`, optional): any additional URL parameters to be be passed</span>
<span class="sd">            data (str): the data that will be submitted via POST. Typically, a dictionary</span>
<span class="sd">                of keys and values, turned into a string with import json; json.dumps()</span>

<span class="sd">        Returns:</span>
<span class="sd">            requests.Response : If the status code is not 401, a ``requests.Response`` object is returned.</span>
<span class="sd">            The structure of the result inside the &#39;text&#39; attribute might vary depending on the REST endpoint</span>
<span class="sd">            called, but typically represents the record resulting from the insert. ServiceNow may also set various</span>
<span class="sd">            HTTP status codes or headers in the response.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SnowRestSessionException : if the operation could not be performed due to an authentication issue</span>

<span class="sd">        Examples:</span>
<span class="sd">            Inserting an incident with the ServiceNow REST Table API:</span>

<span class="sd">            &gt;&gt;&gt; s = SnowRestSession()</span>
<span class="sd">            &gt;&gt;&gt; s.load_config_file(&#39;config.yaml&#39;)</span>
<span class="sd">            &gt;&gt;&gt; incident_attributes = {</span>
<span class="sd">            &gt;&gt;&gt;    &#39;short_description&#39; : &quot;New incident&quot;,</span>
<span class="sd">            &gt;&gt;&gt;    &#39;u_business_service&#39; : &#39;e85a3f3b0a0a8c0a006a2912f2f352d1&#39;,  # Service Element &quot;ServiceNow&quot;</span>
<span class="sd">            &gt;&gt;&gt;    &#39;u_functional_element&#39; : &#39;579fb3d90a0a8c08017ac8a1137c8ee6&#39;,  # Functional Element &quot;ServiceNow&quot;</span>
<span class="sd">            &gt;&gt;&gt;    &#39;comments&#39; : &quot;Initial description&quot;</span>
<span class="sd">            &gt;&gt;&gt; }</span>
<span class="sd">            &gt;&gt;&gt; import json</span>
<span class="sd">            &gt;&gt;&gt; data = json.dumps(incident_attributes)</span>
<span class="sd">            &gt;&gt;&gt; response = s.post(&#39;/api/now/v2/table/incident&#39;, data=data)</span>
<span class="sd">            &gt;&gt;&gt; if response.status_code == 201:</span>
<span class="sd">            &gt;&gt;&gt;     result = json.loads(response.text)</span>
<span class="sd">            &gt;&gt;&gt;     if &#39;result&#39; in result:</span>
<span class="sd">            &gt;&gt;&gt;         incident = result[&#39;result&#39;]</span>
<span class="sd">            &gt;&gt;&gt;         print incident[&#39;number&#39;]  # will print the number of the newly created incident</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__operation</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="SnowRestSession.put"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSession.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a raw PUT operation and returns the result.</span>
<span class="sd">        Used to update records or other information.</span>
<span class="sd">        The authentication method, and session cookie / OAuth tokens persistance will depend on how the session</span>
<span class="sd">        has been configured.</span>

<span class="sd">        Args:</span>
<span class="sd">            url (str): a relative URL, such as ``/api/now/v2/table/incident/c1c535ba85f45540adf94de5b835cd43``.</span>
<span class="sd">                An absolute URL such as ``https://cerntest.service-now.com/api/now/v2/table/incident/c1c535ba85f45540adf94de5b835cd43`` can also</span>
<span class="sd">                be used, but the instance should match with the &quot;instance&quot; parameter in the configuration file,</span>
<span class="sd">                or the value set with the ``.set_instance()`` method.</span>
<span class="sd">            headers (:obj:`dict`, optional): any additional headers to be be passed. If not set, the &#39;Accept&#39; header will be set to</span>
<span class="sd">                &#39;application/json&#39;, and &#39;Content&#39; will be set to &#39;application/json&#39;</span>
<span class="sd">            params (:obj:`dict`, optional): any additional URL parameters to be be passed</span>
<span class="sd">            data (str): the data that will be submitted via PUT. Typically, a dictionary</span>
<span class="sd">                of keys and values, turned into a string with import json; json.dumps()</span>

<span class="sd">        Returns:</span>
<span class="sd">            requests.Response : If the status code is not 401, a ``requests.Response`` object is returned.</span>
<span class="sd">            The structure of the result inside the &#39;text&#39; attribute might vary depending on the REST endpoint</span>
<span class="sd">            called, but typically represents the state of the record after the update.</span>
<span class="sd">            ServiceNow may also set various HTTP status codes or headers in the response.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SnowRestSessionException : if the operation could not be performed due to an authentication issue</span>

<span class="sd">        Examples:</span>
<span class="sd">            Updating an incident with the ServiceNow REST Table API:</span>

<span class="sd">            &gt;&gt;&gt; s = SnowRestSession()</span>
<span class="sd">            &gt;&gt;&gt; s.load_config_file(&#39;config.yaml&#39;)</span>
<span class="sd">            &gt;&gt;&gt; incident_attributes_to_update = {</span>
<span class="sd">            &gt;&gt;&gt;    &#39;watch_list&#39; : &#39;david.martin.clavo@cern.ch&#39;  # will completely replace the previous value</span>
<span class="sd">            &gt;&gt;&gt; }</span>
<span class="sd">            &gt;&gt;&gt; import json</span>
<span class="sd">            &gt;&gt;&gt; data = json.dumps(incident_attributes_to_update)</span>
<span class="sd">            &gt;&gt;&gt; response = s.put(&#39;/api/now/v2/table/incident/ca37ed334f56830015d3bc511310c7a8&#39;, data=data)</span>
<span class="sd">            &gt;&gt;&gt; if response.status_code == 200:</span>
<span class="sd">            &gt;&gt;&gt;     result = json.loads(response.text)</span>
<span class="sd">            &gt;&gt;&gt;     if &#39;result&#39; in result:</span>
<span class="sd">            &gt;&gt;&gt;         incident = result[&#39;result&#39;]</span>
<span class="sd">            &gt;&gt;&gt;         print incident[&#39;number&#39;]  # will print the number of the updated incident</span>
<span class="sd">            &gt;&gt;&gt;         print incident[&#39;watch_list&#39;]  # will print the new value of the watch_list field</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__operation</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="k">def</span> <span class="nf">__call_cern_get_sso_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the cern-get-sso-cookie command (available in CERN Linux environments)</span>
<span class="sd">        in order to perform a Single Sign-On and produce a cookie file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cern-get-sso-cookie&quot;</span><span class="p">,</span> <span class="s2">&quot;--reprocess&quot;</span><span class="p">,</span> <span class="s2">&quot;--url&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;--outfile&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_cookie_file_path</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__good_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cookie_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_cookie_file_path</span><span class="p">)</span>
        <span class="n">cookie_file_contents</span> <span class="o">=</span> <span class="n">cookie_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span>
                <span class="n">cookie_file_contents</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;glide_user_activity&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span>
                <span class="n">cookie_file_contents</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;glide_session_store&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span>
                <span class="n">cookie_file_contents</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;glide_user_route&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span>
                <span class="n">cookie_file_contents</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;JSESSIONID&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span>
                <span class="n">cookie_file_contents</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;BIGipServerpool_cern&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__cern_get_sso_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads and checks an existing cookie file, in order to avoid logging into ServiceNow and the</span>
<span class="sd">        CERN Single-Sign-On if possible. If needed, logs in again into both to produce the cookie file.</span>
<span class="sd">        The cookie file is loaded into memory.</span>
<span class="sd">        If not needed to persist the cookie file, it is deleted.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SnowRestSessionException: if the Single Sign On login is not succesful. This is determined by parsing</span>
<span class="sd">                the cookie file after it is produced.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_cookie_file_path</span><span class="p">):</span>  <span class="c1"># cookie file not present. We perform Single Sign On</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__call_cern_get_sso_cookie</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fresh_cookie</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># cookie file present. We check if it has the correct format</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fresh_cookie</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__good_cookie</span><span class="p">():</span>  <span class="c1"># the format is bad. We create a new cookie file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__call_cern_get_sso_cookie</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fresh_cookie</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># we load the cookie file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_cookie</span> <span class="o">=</span> <span class="n">cookielib</span><span class="o">.</span><span class="n">MozillaCookieJar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_cookie_file_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_cookie</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="c1"># we check if the log in was sucessful</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__good_cookie</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span>
                <span class="s2">&quot;SnowRestSession.__cern_get_sso_cookie: The current account has failed to perform &quot;</span>
                <span class="s2">&quot;a Single-Sign-On login in to ServiceNow&quot;</span><span class="p">)</span>

        <span class="c1"># we load the cookies into the requests.Session session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">cookies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_cookie</span>

        <span class="c1"># if not needed to persist the cookie file, we delete it</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_cookie</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_cookie_file_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__obtain_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the OAuth access and refresh tokens from the token file.</span>
<span class="sd">        If the token file is not present, new OAuth access and refresh tokens are obtained.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SnowRestSessionException: if the OAuth tokens could not be retrieved from ServiceNow.</span>
<span class="sd">            IOError, ValueError: if the token file could not be opened</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oauth_token_file_path</span><span class="p">):</span>  <span class="c1"># tokens file not present. We obtain new tokens</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fresh_token</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">token_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">+</span> <span class="s1">&#39;/oauth_token.do&#39;</span><span class="p">,</span>
                                              <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;grant_type&#39;</span><span class="p">:</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_client_id</span><span class="p">,</span>
                                                    <span class="s1">&#39;client_secret&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_client_secret</span><span class="p">})</span>

            <span class="k">if</span> <span class="n">token_request</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>  <span class="c1"># token request was successful</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">token_request</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_token</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oauth_token_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">token_file</span><span class="p">:</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span><span class="p">,</span> <span class="n">token_file</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># token request failed. Possibly, an existing cookie file contained a timed out session</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fresh_cookie</span><span class="p">:</span>  <span class="c1"># we just performed a Single-Sign-On. There is a problem with token retrieval.</span>
                    <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span>
                        <span class="s2">&quot;SnowRestSession.__obtain_tokens: OAuth tokens could not be retrieved from ServiceNow. &quot;</span>
                        <span class="s2">&quot;Please check the OAuth client id and OAuth client secret.&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>  <span class="c1"># we may need to perform Single-Sign-On again, as the session may have timed out</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__cern_get_sso_cookie</span><span class="p">()</span>
                    <span class="n">token_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">+</span> <span class="s1">&#39;/oauth_token.do&#39;</span><span class="p">,</span>
                                                      <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;grant_type&#39;</span><span class="p">:</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span>
                                                            <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_client_id</span><span class="p">,</span>
                                                            <span class="s1">&#39;client_secret&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_client_secret</span><span class="p">})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">token_request</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">token_request</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_token</span><span class="p">:</span>
                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oauth_token_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">token_file</span><span class="p">:</span>
                                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span><span class="p">,</span> <span class="n">token_file</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span>
                                <span class="s2">&quot;SnowRestSession.__obtain_tokens: OAuth tokens could not be retrieved from ServiceNow. &quot;</span>
                                <span class="s2">&quot;Please check the OAuth client id and OAuth client secret.&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># the tokens file is present. We try to load it</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oauth_token_file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">token_file</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">token_file</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s2">&quot;SnowRestSession.__obtain_tokens: Issue when opening &quot;</span>
                    <span class="s2">&quot;the token file at </span><span class="si">%s</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_token_file_path</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span> <span class="nf">__initiate_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiates a session via CERN Single-Sign-On + OAuth, or basic Authentication</span>

<span class="sd">        Raises:</span>
<span class="sd">            SnowRestSessionException: if auth_type is not &#39;sso_auth&#39; nor &#39;basic&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_type</span> <span class="o">==</span> <span class="s1">&#39;sso_oauth&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cern_get_sso_cookie</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__obtain_tokens</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_type</span> <span class="o">==</span> <span class="s1">&#39;basic&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_password</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">cookies</span> <span class="o">=</span> <span class="n">cookielib</span><span class="o">.</span><span class="n">MozillaCookieJar</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_cookie_file_path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_cookie_file_path</span><span class="p">,</span> <span class="n">ignore_discard</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_expires</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span>
                <span class="s2">&quot;SnowRestSession.__initiate_session: self.auth_type &quot;</span>
                <span class="s2">&quot;has a value different from </span><span class="se">\&quot;</span><span class="s2">basic</span><span class="se">\&quot;</span><span class="s2"> and </span><span class="se">\&quot;</span><span class="s2">sso_auth</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__refresh_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Requests an OAuth access token via the OAUTH refresh token.</span>
<span class="sd">        Saves the resulting access token in the token file.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SnowRestSessionException: if the access token could not be obtained</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">token_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">+</span> <span class="s1">&#39;/oauth_token.do&#39;</span><span class="p">,</span>
                                          <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;grant_type&#39;</span><span class="p">:</span> <span class="s1">&#39;refresh_token&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_client_id</span><span class="p">,</span>
                                                <span class="s1">&#39;client_secret&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_client_secret</span><span class="p">,</span>
                                                <span class="s1">&#39;refresh_token&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span><span class="p">[</span><span class="s1">&#39;refresh_token&#39;</span><span class="p">]})</span>

        <span class="k">if</span> <span class="n">token_request</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">token_request</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oauth_token_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">token_file</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span><span class="p">,</span> <span class="n">token_file</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">token_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">+</span> <span class="s1">&#39;/oauth_token.do&#39;</span><span class="p">,</span>
                                              <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;grant_type&#39;</span><span class="p">:</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_client_id</span><span class="p">,</span>
                                                    <span class="s1">&#39;client_secret&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_client_secret</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">token_request</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">token_request</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oauth_token_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">token_file</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span><span class="p">,</span> <span class="n">token_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fresh_cookie</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span>
                        <span class="s2">&quot;SnowRestSession.__refresh_token: the OAuth client id and OAuth secret might not be valid&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__save_cookie_basic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Persists the basic authentication cookie file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fresh_cookie</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_cookie_file_path</span><span class="p">,</span> <span class="n">ignore_discard</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_expires</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__library_user_agent</span><span class="p">():</span>
        <span class="n">user_agent_header</span> <span class="o">=</span> <span class="s1">&#39;cern-snow-client/&#39;</span> <span class="o">+</span> <span class="n">__version__</span>
        <span class="n">default_headers</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">default_headers</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;User-Agent&#39;</span> <span class="ow">in</span> <span class="n">default_headers</span><span class="p">:</span>
            <span class="n">user_agent_header</span> <span class="o">=</span> <span class="n">user_agent_header</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">default_headers</span><span class="p">[</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">user_agent_header</span>

    <span class="k">def</span> <span class="nf">__execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes directly a REST Operation and returns the result</span>

<span class="sd">        Args:</span>
<span class="sd">            operation (str): either &#39;get&#39;, &#39;post&#39; or &#39;put&#39;</span>
<span class="sd">            url (str): a relative URL, such as &quot;/api/now/v2/table/incident&quot;.</span>
<span class="sd">                An absolute URL such as &quot;https://cerntest.service-now.com/api/now/v2/table/incident&quot; can also</span>
<span class="sd">                be used, but the instance should match with the &quot;instance&quot; parameter in the configuration file,</span>
<span class="sd">                or the value set with the ``.set_instance()`` method.</span>
<span class="sd">            headers (:obj:`dict`, optional): any additional headers to be be passed. This method will add</span>
<span class="sd">                Accept:application/json and Content-Type:application/json if not specified.</span>
<span class="sd">                It will also add the Authorization header if the authentication type is &#39;sso_auth&#39;,</span>
<span class="sd">                by setting it to the OAuth access header.</span>
<span class="sd">            params (:obj:`dict`, optional): any additional URL parameters to be be passed</span>
<span class="sd">            data (object): the data to be sent in a post or put operation</span>

<span class="sd">        Returns:</span>
<span class="sd">            requests.Response</span>

<span class="sd">        Raises:</span>
<span class="sd">            SnowRestSessionException: if the operation parameter is not &#39;get&#39;, &#39;post&#39; or &#39;put&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">operation</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span><span class="s2">&quot;SnowRestSession.__execute: the operation paramater is mandatory&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span><span class="s2">&quot;SnowRestSession.__execute: the url paramater is mandatory&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;https://&#39;</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">+</span> <span class="n">url</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;https://&#39;</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">+</span> <span class="n">url</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;User-Agent&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__library_user_agent</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;Accept&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Accept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;post&#39;</span> <span class="ow">or</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;put&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;Content-Type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_type</span> <span class="o">==</span> <span class="s1">&#39;sso_oauth&#39;</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;get&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;post&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;put&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span><span class="s2">&quot;SnowRestSession.__execute: the operation paramater &quot;</span>
                                           <span class="s2">&quot;needs to be either </span><span class="se">\&quot;</span><span class="s2">get</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">post</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">put</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">__operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a REST Operation, taking care of reauthenticating if needed, and returns the result</span>

<span class="sd">        Args:</span>
<span class="sd">            operation (str): either &#39;get&#39;, &#39;post&#39; or &#39;put&#39;</span>
<span class="sd">            url (str): a relative URL, such as &quot;/api/now/v2/table/incident&quot;.</span>
<span class="sd">                An absolute URL such as &quot;https://cerntest.service-now.com/api/now/v2/table/incident&quot; can also</span>
<span class="sd">                be used, but the instance should match with the &quot;instance&quot; parameter in the configuration file,</span>
<span class="sd">                or the value set with the ``.set_instance()`` method.</span>
<span class="sd">            headers (:obj:`dict`, optional): any additional headers to be be passed. If not set, some headers will be set by</span>
<span class="sd">                default (see __execute method)</span>
<span class="sd">            params (:obj:`dict`, optional): any additional URL parameters to be be passed</span>
<span class="sd">            data (object): the data to be sent in a post or put operation</span>

<span class="sd">        Returns:</span>
<span class="sd">            requests.Response : if the status code is not 401, a requests.Response object is returned</span>

<span class="sd">        Raises:</span>
<span class="sd">            SnowRestSessionException : if the operation could not be performed due to an authentication issue</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initiate_session</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">401</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_type</span> <span class="o">==</span> <span class="s1">&#39;basic&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__save_cookie_basic</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_type</span> <span class="o">==</span> <span class="s1">&#39;basic&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fresh_cookie</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_auth_password</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">401</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__save_cookie_basic</span><span class="p">()</span>
                        <span class="k">return</span> <span class="n">result</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span>
                            <span class="s2">&quot;SnowRestSession.__operation: Your basic authentication &quot;</span>
                            <span class="s2">&quot;user and password might not be valid&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span>
                        <span class="s2">&quot;SnowRestSession.__operation: Your basic authentication &quot;</span>
                        <span class="s2">&quot;user and password might not be valid&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_type</span> <span class="o">==</span> <span class="s1">&#39;sso_auth&#39;</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fresh_token</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span>
                        <span class="s2">&quot;SnowRestSession.__operation: failed to perform the operation. The current account might not &quot;</span>
                        <span class="s2">&quot;be able to log in to ServiceNow or the OAuth client id and secret might not be valid&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__refresh_token</span><span class="p">()</span>
                    <span class="n">token_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">+</span> <span class="s1">&#39;/oauth_token.do&#39;</span><span class="p">,</span>
                                                      <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;grant_type&#39;</span><span class="p">:</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span>
                                                            <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_client_id</span><span class="p">,</span>
                                                            <span class="s1">&#39;client_secret&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_client_secret</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">token_request</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">token_request</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oauth_token_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">token_file</span><span class="p">:</span>
                            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span><span class="p">,</span> <span class="n">token_file</span><span class="p">)</span>
                        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">401</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">result</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span>
                                <span class="s2">&quot;SnowRestSession.__operation: failed to perform the operation. &quot;</span>
                                <span class="s2">&quot;The current account might not be able to log in to ServiceNow or &quot;</span>
                                <span class="s2">&quot;the OAuth client id and secret might not be valid&quot;</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fresh_cookie</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span>
                                <span class="s2">&quot;SnowRestSession.__operation: OAuth tokens could not be retrieved from ServiceNow. &quot;</span>
                                <span class="s2">&quot;Please check the OAuth client id and OAuth client secret.&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_cookie_file_path</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__cern_get_sso_cookie</span><span class="p">()</span>
                            <span class="n">token_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">+</span> <span class="s1">&#39;/oauth_token.do&#39;</span><span class="p">,</span>
                                                              <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;grant_type&#39;</span><span class="p">:</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span>
                                                                    <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_client_id</span><span class="p">,</span>
                                                                    <span class="s1">&#39;client_secret&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oauth_client_secret</span><span class="p">})</span>
                            <span class="k">if</span> <span class="n">token_request</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span>
                                    <span class="s2">&quot;SnowRestSession.__operation: OAuth tokens could not be retrieved from ServiceNow. &quot;</span>
                                    <span class="s2">&quot;Please check the OAuth client id and OAuth client secret.&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">token_request</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oauth_token_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">token_file</span><span class="p">:</span>
                                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span><span class="p">,</span> <span class="n">token_file</span><span class="p">)</span>
                                <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_dic</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span>
                                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                                                        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">401</span><span class="p">:</span>
                                    <span class="k">return</span> <span class="n">result</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span>
                                        <span class="s2">&quot;SnowRestSession.__operation: failed to perform the operation. &quot;</span>
                                        <span class="s2">&quot;The current account might not be able to log in to ServiceNow or &quot;</span>
                                        <span class="s2">&quot;the OAuth client id and secret might not be valid&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SnowRestSessionException</span><span class="p">(</span>
                    <span class="s2">&quot;SnowRestSession.__operation: self.auth_type has a value different from </span><span class="se">\&quot;</span><span class="s2">basic</span><span class="se">\&quot;</span><span class="s2"> and </span><span class="se">\&quot;</span><span class="s2">sso_auth</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_configure_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_handler</span><span class="p">)</span>

        <span class="n">file_handler_attributes_known</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_file_path</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_file_size_bytes</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_file_rotations</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_file_encoding</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_format</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">file_handler_attributes_known</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_handler</span> <span class="o">=</span> <span class="n">RotatingFileHandler</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_file_path</span><span class="p">,</span>
                <span class="n">maxBytes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_file_size_bytes</span><span class="p">,</span>
                <span class="n">backupCount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_file_rotations</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_file_encoding</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_format</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_handler</span> <span class="o">=</span> <span class="n">NullHandler</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_handler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_critical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></div>


<div class="viewcode-block" id="SnowRestSessionException"><a class="viewcode-back" href="../../cern_snow_client.html#cern_snow_client.session.SnowRestSessionException">[docs]</a><span class="k">class</span> <span class="nc">SnowRestSessionException</span><span class="p">(</span><span class="n">SnowClientException</span><span class="p">):</span>
    <span class="k">pass</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">cern-snow-client 0.3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, James Clerc, David Martin Clavo.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.5.
    </div>
  </body>
</html>